<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Anime Quiz ‚Äî Mini App</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:Arial,Helvetica,sans-serif;padding:12px;max-width:900px;margin:auto}
    .panel{border:1px solid #ddd;padding:10px;border-radius:8px;margin-bottom:10px}
    .players{margin:8px 0}
    .player{padding:6px 8px;border-bottom:1px solid #eee}
    .player:last-child{border-bottom:none}
    .btn{display:inline-block;padding:8px 12px;border-radius:6px;border:0;background:#2b7de9;color:#fff;cursor:pointer;margin:6px 4px}
    .btn.secondary{background:#6c757d}
    .options{margin-top:10px}
    .opt{display:block;padding:8px;border-radius:6px;border:1px solid #ccc;margin:6px 0;cursor:pointer}
    .opt.disabled{opacity:0.6;pointer-events:none}
    #status{color:#555;margin-bottom:8px}
  </style>
</head>
<body>
  <h2>Anime Quiz</h2>
  <div id="status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

  <div class="panel" id="adminPanel" style="display:none">
    <h3>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h3>
    <div>
      <button class="btn" onclick="adminStart()">üéØ –ù–∞—á–∞—Ç—å —Ä–∞—É–Ω–¥</button>
      <button class="btn secondary" onclick="adminReset()">üîÑ –°–±—Ä–æ—Å–∏—Ç—å</button>
    </div>
    <div class="players" id="playersList"></div>
  </div>

  <div class="panel" id="playerPanel" style="display:none">
    <h3>–ö–≤–∏–∑</h3>
    <div id="questionBox">–í–æ–ø—Ä–æ—Å–∞ –ø–æ–∫–∞ –Ω–µ—Ç</div>
    <div class="options" id="optionsBox"></div>
    <div id="playerNotice"></div>
  </div>

<script>
const qs = Object.fromEntries(new URLSearchParams(window.location.search));
const chat_id = qs.chat_id;
let user_id = qs.user_id;
const API_BASE = window.location.origin;

const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
  // override user_id if available
  user_id = user_id || tg.initDataUnsafe.user.id;
}

if (!chat_id || !user_id) {
  document.getElementById('status').innerText = "–û—à–∏–±–∫–∞: –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω—ã chat_id/user_id –≤ URL. –û—Ç–∫—Ä–æ–π—Ç–µ –∫–≤–∏–∑ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –≤ —á–∞—Ç–µ.";
} else {
  init();
}

function init(){
  document.getElementById('status').innerText = "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...";
  loadState();
  // poll state
  setInterval(loadState, 2500);
}

async function loadState(){
  try {
    const r = await fetch(`${API_BASE}/api/get_state?chat_id=${chat_id}&user_id=${user_id}`);
    const data = await r.json();
    if (!data.ok) {
      document.getElementById('status').innerText = "–ò–≥—Ä–∞ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞. –ü–æ–ø—Ä–æ—Å–∏—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ /register –≤ —á–∞—Ç–µ.";
      return;
    }
    document.getElementById('status').innerText = data.role === 'admin' ? "–í—ã: –ê–¥–º–∏–Ω" : "–í—ã: –£—á–∞—Å—Ç–Ω–∏–∫";
    // players
    const plDiv = document.getElementById('playersList');
    plDiv.innerHTML = "";
    for (const uid in data.players){
      const p = data.players[uid];
      const el = document.createElement('div');
      el.className = 'player';
      el.innerText = `${p.name} ${p.answered ? " ‚Äî –æ—Ç–≤–µ—Ç–∏–ª ‚úÖ" : " ‚Äî –∂–¥—ë—Ç ‚è≥"}`;
      plDiv.appendChild(el);
    }
    // show panels
    if (data.role === 'admin') document.getElementById('adminPanel').style.display='block'; else document.getElementById('adminPanel').style.display='none';
    document.getElementById('playerPanel').style.display = 'block';

    // question
    const q = data.question;
    const qBox = document.getElementById('questionBox');
    const optsBox = document.getElementById('optionsBox');
    if (!q) {
      qBox.innerText = "–í–æ–ø—Ä–æ—Å–∞ –ø–æ–∫–∞ –Ω–µ—Ç. –ñ–¥–∏—Ç–µ, –ø–æ–∫–∞ –∞–¥–º–∏–Ω –Ω–∞—á–Ω—ë—Ç —Ä–∞—É–Ω–¥.";
      optsBox.innerHTML = "";
      return;
    }
    qBox.innerText = q.question;
    optsBox.innerHTML = "";
    // is current user already answered?
    const answered = data.players[String(user_id)] && data.players[String(user_id)].answered;
    for (let i=0;i<q.options.length;i++){
      const opt = document.createElement('div');
      opt.className = 'opt' + (answered ? ' disabled' : '');
      opt.innerText = `${i+1}. ${q.options[i]}`;
      opt.onclick = ()=> submitAnswer(i);
      optsBox.appendChild(opt);
    }
  } catch (e) {
    console.error(e);
    document.getElementById('status').innerText = "–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º";
  }
}

async function submitAnswer(idx){
  try {
    const payload = {
      chat_id: chat_id,
      user: { id: Number(user_id) },
      given: idx
    };
    const res = await fetch(`${API_BASE}/api/submit`, {
      method: "POST",
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (!data.ok) {
      alert("–û—à–∏–±–∫–∞: " + (data.error || JSON.stringify(data)));
    } else {
      document.getElementById('playerNotice').innerText = "–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.";
      loadState();
    }
  } catch (e) {
    alert("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: " + e.message);
  }
}

// admin actions
async function adminStart(){
  try {
    const res = await fetch(`${API_BASE}/api/admin/start`, {
      method: "POST",
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ chat_id: Number(chat_id), user_id: Number(user_id) })
    });
    const data = await res.json();
    if (!data.ok) alert("–û—à–∏–±–∫–∞ —Å—Ç–∞—Ä—Ç–∞: " + JSON.stringify(data));
    else {
      loadState();
      // optionally, close WebApp to return to chat
      if (tg) tg.close();
    }
  } catch (e) { alert("–û—à–∏–±–∫–∞: "+e.message); }
}

async function adminReset(){
  if (!confirm("–°–±—Ä–æ—Å–∏—Ç—å –∏–≥—Ä—É (—É–¥–∞–ª–∏—Ç—å –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤)?")) return;
  try {
    const res = await fetch(`${API_BASE}/api/admin/reset`, {
      method: "POST",
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ chat_id: Number(chat_id), user_id: Number(user_id) })
    });
    const data = await res.json();
    if (!data.ok) alert("–û—à–∏–±–∫–∞: "+JSON.stringify(data));
    else loadState();
  } catch (e) { alert("–û—à–∏–±–∫–∞: "+e.message); }
}
</script>
</body>
</html>
